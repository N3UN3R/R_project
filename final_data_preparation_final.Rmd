---
  title: "Case Study Group 7"
author: "Timon Zimmermann, Lüko Neuner-Jehle, Johannes Florstedt, Enis XXX, Hendrik Dybus"
date: "07.02.2024"
output: 
  html_document:
  toc: true
toc_float: true
code_folding: hide
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Bibliothek
Für die Durchführung der folgenden datengestützten Analyse sind mehrere **R-Pakete** erforderlich.
Nachfolgend werden die benötigten Pakete geladen

```{r, message=FALSE, warning = FALSE, cache = TRUE}
#Installation und Laden des Pakets "install.load", falls erforderlich. 
# Hinweis: Das "install.load"-Paket enthält die Funktion install_load.

if(!require(install.load)){
  install.packages("install.load")
  library(install.load)
}

# Installation und Laden der genannten Pakete, falls erforderlich   
install_load("dplyr", "readr", "data.table",  "shiny", "tidyr", "DT", "ggplot2", "stringr")
```



#Hilfsfunktionen zur Datenbereinigung

```{r, message=FALSE, warning = FALSE, cache = TRUE}
find_wrong_names <- function(data, prefixes) {
  filtered_data <- list()
  
  for (prefix in prefixes) {
    # Konvertieren der Gemeinden in Großbuchstaben
    data$Gemeinden <- toupper(data$Gemeinden)
    # Filtern der Gemeinden, die mit dem aktuellen Präfix beginnen
    filtered_data[[prefix]] <- data[grepl(paste0("^", prefix), data$Gemeinden), ]
  }
  
  return(filtered_data)
}


#Funktion zum Ersetzen der fehlerhaften Namen
update_gemeinden_fehlerhaft <- function(data, old_name, new_name) {
  # Ersetzen des alten Namens durch den neuen Namen, nur ganze Wörter
  data$Gemeinden <- gsub(paste0("\\b", old_name, "\\b"), new_name, data$Gemeinden, perl = TRUE)
  
  return(data)
}

#hilfsfunktion zum Zusammenfügen von Spalten
merge_columns <- function(df) {
  # Finden aller Spalten, die auf .x enden
  cols_x <- names(df)[grepl("\\.x$", names(df))]
  # Ersetzen von .x mit leerem String, um die Originalnamen zu erhalten
  original_cols <- gsub("\\.x$", "", cols_x)
  
  for (col in original_cols) {
    # Generiere die Namen der .y Spalten basierend auf den .x Spalten
    col_y <- paste0(col, ".y")
    # Überprüfe, ob sowohl .x als auch .y Spalten existieren
    if(col_y %in% names(df)) {
      # Verwende coalesce, um die Spalten zusammenzuführen
      df[[col]] <- coalesce(df[[paste0(col, ".x")]], df[[col_y]])
      # Entferne die ursprünglichen .x und .y Spalten
      df[[paste0(col, ".x")]] <- NULL
      df[[col_y]] <- NULL
    }
  }
  
  return(df)
}

```

# Lese Zulassungen aller Fahrzeuge als erste Datei ein
Aufgrund von schlechter Datenqualität werden fehlerhafte Daten durch Anwendung der oben erzeugten Hilfsfunktionen eresetzt und korrigiert.
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#einlesen der Daten
zulassungen <- fread("C:/Users/lueko/Data Science/Data/Zulassungen_alle_Fahrzeuge.csv", header = TRUE, data.table = FALSE, encoding = "Latin-1" )

#Analyse der Zulassungsgemeinden
einzigartige_werte <- zulassungen %>%
  group_by(Gemeinden) %>%
  summarise(Anzahl = n()) %>%
  ungroup()

#glimpse(einzigartige_werte)

#Bei der Analyse der Orte fällt auf, dass teilweise Orte falsch geschrieben sind, nachfolgend werden die falschen Gemeinden analysiert und erneuert

# Präfixe definieren
prefixes <- c("AACH", "BON", "KOEL", "DORT", "BIEL", "OBERHAUS", "BOCH", "MUENSTER")

# Anwendung der Funktion auf die Gemeindedaten
zulassungen_fehlerhaft_gemeinden <- find_wrong_names(zulassungen, prefixes)

# Überprüfen der gefilterten Ergebnisse für jedes Präfix
for (prefix in prefixes) {
  cat("Gefilterte Ergebnisse für", prefix, ":\n")
  print(unique(zulassungen_fehlerhaft_gemeinden[[prefix]]$Gemeinden))
  cat("\n")
}

# Anwenden der Funktion update_gemeinden auf die Zulassungsdaten
zulassungen <- update_gemeinden_fehlerhaft(zulassungen, "AACH", "AACHEN")
zulassungen <- update_gemeinden_fehlerhaft(zulassungen, "AACH1", "AACHEN")
zulassungen <- update_gemeinden_fehlerhaft(zulassungen, "OBERHAUSEN1", "OBERHAUSEN")
zulassungen <- update_gemeinden_fehlerhaft(zulassungen, "OBERHAUSEN2", "OBERHAUSEN")
zulassungen <- update_gemeinden_fehlerhaft(zulassungen, "OBERHAUSEN3", "OBERHAUSEN")
zulassungen <- update_gemeinden_fehlerhaft(zulassungen, "MUENSTER1", "MUENSTER")

#Benenne IdNummern in ID_Fahrzeug um - dieser Schritt ist erforderlich um einheitliche Ids zu haben
zulassungen <- zulassungen %>%
  rename(ID_Fahrzeug = IDNummer)

#glimpse(zulassungen)

zulassungen_filtered <- zulassungen %>% 
  filter(tolower(Gemeinden) %in% tolower(c("Koeln", "Dortmund", "Bielefeld", "Bonn", "Oberhausen", "Bochum", "Muenster", "Aachen")))
  #tolower ermöglicht, dass die string sowohl ins capslock, als auch klein oder mischung gefiltert werden

glimpse(zulassungen_filtered)

```


# Lade die Fahrzeugdaten für jeden OEM Typ

Dafür werden nachfolgend die entsprechenden .csv Dateien eingelesen.
```{r, message=FALSE, warning = FALSE, cache = TRUE}
# CSV-Datei einlesen

# Import von Fahrzeug typ 11
Fahrzeug_Typ11 <- fread("Data/Fahrzeug/Fahrzeuge_OEM1_Typ11.csv", header = TRUE, data.table = FALSE, select =  c("ID_Fahrzeug", "Produktionsdatum", "Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum"))
# Import von Fahrzeug typ 12
Fahrzeug_Typ12 <- fread("Data/Fahrzeug/Fahrzeuge_OEM1_Typ12.csv", header = TRUE, data.table = FALSE, select =  c("ID_Fahrzeug", "Produktionsdatum", "Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum"))
# Import von Fahrzeug typ 21
Fahrzeug_Typ21 <- fread("Data/Fahrzeug/Fahrzeuge_OEM2_Typ21.csv", header = TRUE, data.table = FALSE, select =  c("ID_Fahrzeug", "Produktionsdatum", "Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum"))
# Import von Fahrzeug typ 22
Fahrzeug_Typ22 <- fread("Data/Fahrzeug/Fahrzeuge_OEM2_Typ22.csv", header = TRUE, data.table = FALSE, select =  c("ID_Fahrzeug", "Produktionsdatum", "Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum"))
                        
#glimpse(Fahrzeug_Typ11)
#glimpse(Fahrzeug_Typ12)
#glimpse(Fahrzeug_Typ21)
#glimpse(Fahrzeug_Typ22)

```

# Daten nach den IDs in fahrzeug_id_zulassungen filtern
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#zusammenfügen von Fahrzeugdaten
oem_integrated <- left_join(zulassungen_filtered,Fahrzeug_Typ11, by = "ID_Fahrzeug")
oem_integrated <- left_join(oem_integrated,Fahrzeug_Typ12, by = "ID_Fahrzeug")
oem_integrated <- merge_columns(oem_integrated)
oem_integrated <- left_join(oem_integrated,Fahrzeug_Typ21, by = "ID_Fahrzeug")
oem_integrated <- merge_columns(oem_integrated)
oem_integrated <- left_join(oem_integrated,Fahrzeug_Typ22, by = "ID_Fahrzeug")
oem_integrated <- merge_columns(oem_integrated)

glimpse(oem_integrated)

```
#geodaten einlesen und an den Datensatz angliedern
```{r, message=FALSE, warning = FALSE, cache = TRUE}

geodaten <- fread("Data/Geodaten/Geodaten/Geodaten_Gemeinden_v1.2_2017-08-22_TrR.csv", header = TRUE, data.table = FALSE, encoding = "Latin-1" )
geodaten <- geodaten %>%
  rename(Gemeinden = Gemeinde) %>%
   select(-V1,-X,-Postleitzahl)


oem_integrated <- oem_integrated %>% 
  select(-V1,-Zulassung,-Produktionsdatum,-Werksnummer,-Fehlerhaft,-Fehlerhaft_Datum)

oem_integrated_geo <-left_join(fahrzeuge_ges_filtered_years,geodaten,by="Gemeinden")

glimpse(oem_integrated_geo)








```



#Auslesen von bestandteilen
Die Bestandteile widerum enthalten Informationen zu den Komponenten des Fahrzeugs.
```{r, message=FALSE, warning = FALSE, cache = TRUE}

#Einlesen der Fahrzeugbestandteile von Fahrzeug Typ 11
bestandteile_Typ11 <- fread("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ11.csv", header = TRUE, data.table = FALSE)
#entferne die index spalte
bestandteile_Typ11 <- bestandteile_Typ11 %>% 
  select(-V1)

#Einlesen der Fahrzeugbestandteile von Fahrzeug Typ 12
bestandteile_Typ12 <- fread("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ12.csv", header = TRUE, data.table = FALSE)
#entferne die index spalte
bestandteile_Typ12 <- bestandteile_Typ12 %>%
  select(-V1)

#Einlesen der Fahrzeugbestandteile von Fahrzeug Typ 21
bestandteile_Typ21 <- fread("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM2_Typ21.csv", header = TRUE, data.table = FALSE)
#entferne die index spalte
bestandteile_Typ21 <- bestandteile_Typ21 %>%
  select(-V1)

#Einlesen der Fahrzeugbestandteile von Fahrzeug Typ 22
bestandteile_Typ22 <- fread("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM2_Typ22.csv", header = TRUE, data.table = FALSE)
#entferne die index spalte
bestandteile_Typ22 <- bestandteile_Typ22 %>%
  select(-X1)


#glimpse(bestandteile_Typ11)
#glimpse(bestandteile_Typ12)
#glimpse(bestandteile_Typ21)
#glimpse(bestandteile_Typ22)
```


# Aalyse der pro Fahrzeugtyp verbauten Komponenten

Der nachfolgenbde Code diente lediglich dazu herauszufinden, welche "keys" bei den jeweiligen Fahrzeugen enthalten sind.
Für die Analyse ist der Codeabschnitt nicht erforderlich, jedoch aus Gründen der Vollständigkeit enthalten.
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#die Ids selbst sind in der jeweiligen column
carosserie_Ids_11_key = unique(sapply(strsplit(bestandteile_Typ11$ID_Karosserie, "-"), `[`, 1))
schaltung_Ids_11_key = unique(sapply(strsplit(bestandteile_Typ11$ID_Schaltung, "-"), `[`, 1))
sitze_Ids_11_key = unique(sapply(strsplit(bestandteile_Typ11$ID_Sitze, "-"), `[`, 1))
motor_Ids_11_key = unique(sapply(strsplit(bestandteile_Typ11$ID_Motor, "-"), `[`, 1))

#hier kann man eine Prüfung durchführen, ob die Länge von unique immer 1 ist um klar zu zuweisen, dass es immer nur 1 gibt
print(carosserie_Ids_11_key)
print(schaltung_Ids_11_key)
print(sitze_Ids_11_key)
print(motor_Ids_11_key)

#die Ids selbst sind in der jeweiligen column
carosserie_Ids_12_key = unique(sapply(strsplit(bestandteile_Typ12$ID_Karosserie, "-"), `[`, 1))
schaltung_Ids_12_key = unique(sapply(strsplit(bestandteile_Typ12$ID_Schaltung, "-"), `[`, 1))
sitze_Ids_12_key = unique(sapply(strsplit(bestandteile_Typ12$ID_Sitze, "-"), `[`, 1))
motor_Ids_12_key = unique(sapply(strsplit(bestandteile_Typ12$ID_Motor, "-"), `[`, 1))

#hier kann man eine Prüfung durchführen, ob die Länge von unique immer 1 ist um klar zu zuweisen, dass es immer nur 1 gibt
print(carosserie_Ids_12_key)
print(schaltung_Ids_12_key)
print(sitze_Ids_12_key)
print(motor_Ids_12_key)


#die Ids selbst sind in der jeweiligen column
carosserie_Ids_21_key = unique(sapply(strsplit(bestandteile_Typ21$ID_Karosserie, "-"), `[`, 1))
schaltung_Ids_21_key = unique(sapply(strsplit(bestandteile_Typ21$ID_Schaltung, "-"), `[`, 1))
sitze_Ids_21_key = unique(sapply(strsplit(bestandteile_Typ21$ID_Sitze, "-"), `[`, 1))
motor_Ids_21_key = unique(sapply(strsplit(bestandteile_Typ21$ID_Motor, "-"), `[`, 1))

#hier kann man eine Prüfung durchführen, ob die Länge von unique immer 1 ist um klar zu zuweisen, dass es immer nur 1 gibt
print(carosserie_Ids_21_key)
print(schaltung_Ids_21_key)
print(sitze_Ids_21_key)
print(motor_Ids_21_key)


#die Ids selbst sind in der jeweiligen column
carosserie_Ids_22_key = unique(sapply(strsplit(bestandteile_Typ22$ID_Karosserie, "-"), `[`, 1))
schaltung_Ids_22_key = unique(sapply(strsplit(bestandteile_Typ22$ID_Schaltung, "-"), `[`, 1))
sitze_Ids_22_key = unique(sapply(strsplit(bestandteile_Typ22$ID_Sitze, "-"), `[`, 1))
motor_Ids_22_key = unique(sapply(strsplit(bestandteile_Typ22$ID_Motor, "-"), `[`, 1))

#hier kann man eine Prüfung durchführen, ob die Länge von unique immer 1 ist um klar zu zuweisen, dass es immer nur 1 gibt
print(carosserie_Ids_22_key)
print(schaltung_Ids_22_key)
print(sitze_Ids_22_key)
print(motor_Ids_22_key)
```


#komponenten einlesen

Nachfolgend werden die .csv Dateien der Komponenten eingelesen.
Zur Besseren Nachvollziehbarkeit wurde auf eine Implementierung mittels for-loop verzichtet.
```{r, message=FALSE, warning = FALSE, cache = TRUE}

#Einlesen der Komponente
bestandteile_motor_K1BE1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K1BE1.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_motor_K1BE2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K1BE2.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_motor_K1DI1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K1DI1.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_motor_K1DI2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K1DI2.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_sitze_K2LE1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K2LE1.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_sitze_K2LE2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K2LE2.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_sitze_K2ST1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K2ST1.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_sitze_K2ST2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K2ST2.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_schaltung_K3AG1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K3AG1.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_schaltung_K3AG2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K3AG2.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_schaltung_K3SG1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K3SG1.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_schaltung_K3SG2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K3SG2.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_carosserie_K4 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K4.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_carosserie_K5 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K5.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_carosserie_K6 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K6.csv", header = TRUE, data.table = FALSE)

#Einlesen der Komponente
bestandteile_carosserie_K7 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K7.csv", header = TRUE, data.table = FALSE)
```


#Vorbereitung zur Erstellung von Fahrzeugtypbezogenen dataframes

Im nachfolgenden Codeabschnitt werden für jeden Fahrzeugtyp dataframes erstellt, die die entsprechenden Komponenten beinhalten.
Zur Vermeidung von Fehlern und zur Erhöhung der Nachvollziehbarkeit wurde auf alternative Ansätze des nachfolgenden Codeabschnitts, beispielsweise durch Funktionen, verzichtet.
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#basierend auf dem vorletzten schritt können nun die entsprechenden dataframes gemachted werden
#über die zuvor identifizierten "unique keys"  wird gematched
#man hätte es auch ohne eine aufschlüsselung in die einzelnen Fahrzeugtypen machen könnnen, allerdings sind auf diesem Weg mehr Informationen vorhanden
#würde auch gehen, wenn man den großen Datensatz nimmmt und die Fahrzeug IDs behält


# matching karosserie types
bauteile_carosserie_typ11 <- inner_join(bestandteile_carosserie_K4, bestandteile_Typ11, by = c("ID_K4" = "ID_Karosserie")) %>%
  #renaming to have a column called ID_Karosserie instead of ID_K4
  rename(ID_Karosserie = ID_K4) %>%
  # Auswählen der gewünschten Spalten
  select(ID_T30, ID_T31, ID_T32, ID_Fahrzeug, ID_Karosserie)

bauteile_carosserie_typ12 <- inner_join(bestandteile_carosserie_K5, bestandteile_Typ12, by = c("ID_K5" = "ID_Karosserie")) %>%
  rename(ID_Karosserie = ID_K5) %>%
  select(ID_T30, ID_T31, ID_T33, ID_Fahrzeug, ID_Karosserie)

bauteile_carosserie_typ21 <- inner_join(bestandteile_carosserie_K6, bestandteile_Typ21, by = c("ID_K6" = "ID_Karosserie"))%>%
  rename(ID_Karosserie = ID_K6) %>%
  select(ID_T34, ID_T35, ID_T36,ID_T37, ID_Fahrzeug, ID_Karosserie)

bauteile_carosserie_typ22 <- inner_join(bestandteile_carosserie_K7, bestandteile_Typ22, by = c("ID_K7" = "ID_Karosserie"))%>%
  rename(ID_Karosserie = ID_K7) %>%
  select(ID_T34, ID_T35, ID_T38,ID_T39,ID_T40, ID_Fahrzeug, ID_Karosserie)


#matching schaltung
#typ 11 hat "K3SG1" "K3AG1"als schaltungen
bauteile_schaltung1_typ11 <- inner_join(bestandteile_schaltung_K3AG1, bestandteile_Typ11, by = c("ID_K3AG1" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3AG1) %>%
  select(ID_T21, ID_T24, ID_T25, ID_Fahrzeug, ID_Schaltung)

bauteile_schaltung2_typ11 <- inner_join(bestandteile_schaltung_K3SG1, bestandteile_Typ11, by = c("ID_K3SG1" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3SG1) %>%
  select(ID_T21, ID_T22, ID_T23, ID_Fahrzeug, ID_Schaltung)

#typ 12 hat "K3SG1" "K3AG1"als Schaltungen
bauteile_schaltung1_typ12 <- inner_join(bestandteile_schaltung_K3AG1, bestandteile_Typ12, by = c("ID_K3AG1" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3AG1) %>%
  select(ID_T21, ID_T24, ID_T25, ID_Fahrzeug, ID_Schaltung)

bauteile_schaltung2_typ12 <- inner_join(bestandteile_schaltung_K3SG1, bestandteile_Typ12, by = c("ID_K3SG1" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3SG1) %>%
  select(ID_T21, ID_T22, ID_T23, ID_Fahrzeug, ID_Schaltung)

#type 21 hat "K3AG2" "K3SG2" als SChaltungen
bauteile_schaltung1_typ21 <- inner_join(bestandteile_schaltung_K3AG2, bestandteile_Typ21, by = c("ID_K3AG2" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3AG2) %>%
  select(ID_T21, ID_T24, ID_T27, ID_Fahrzeug, ID_Schaltung)

bauteile_schaltung2_typ21 <- inner_join(bestandteile_schaltung_K3SG2, bestandteile_Typ21, by = c("ID_K3SG2" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3SG2) %>%
  select(ID_T21, ID_T22, ID_T26, ID_Fahrzeug, ID_Schaltung)

#type 22 hat "K3AG2" "K3SG2 als Schaltungen
bauteile_schaltung1_typ22 <- inner_join(bestandteile_schaltung_K3AG2, bestandteile_Typ21, by = c("ID_K3AG2" = "ID_Schaltung"))%>%
  rename(ID_Schaltung = ID_K3AG2) %>%
  select(ID_T21, ID_T24, ID_T27, ID_Fahrzeug, ID_Schaltung)

bauteile_schaltung2_typ22 <- inner_join(bestandteile_schaltung_K3SG2, bestandteile_Typ21, by = c("ID_K3SG2" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3SG2) %>%
  select(ID_T21, ID_T22, ID_T26, ID_Fahrzeug, ID_Schaltung)


#matching sitze
#type 11 hat die sitze "K2LE1" "K2ST1"
bauteile_sitze1_typ11 <- inner_join(bestandteile_sitze_K2LE1, bestandteile_Typ11, by = c("ID_K2LE1" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2LE1) %>%
  select(ID_T11, ID_T14, ID_T15, ID_Fahrzeug, ID_Sitze)

bauteile_sitze2_typ11 <- inner_join(bestandteile_sitze_K2ST1, bestandteile_Typ11, by = c("ID_K2ST1" = "ID_Sitze"))%>%
  rename(ID_Sitze = ID_K2ST1) %>%
  select(ID_T11, ID_T12, ID_T13, ID_Fahrzeug, ID_Sitze)

#type 12 hat die sitze "K2LE1" "K2ST1"
bauteile_sitze1_typ12 <- inner_join(bestandteile_sitze_K2LE1, bestandteile_Typ12, by = c("ID_K2LE1" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2LE1) %>%
  select(ID_T11, ID_T14, ID_T15, ID_Fahrzeug, ID_Sitze)

bauteile_sitze2_typ12 <- inner_join(bestandteile_sitze_K2ST1, bestandteile_Typ12, by = c("ID_K2ST1" = "ID_Sitze"))%>%
  rename(ID_Sitze = ID_K2ST1) %>%
  select(ID_T11, ID_T12, ID_T13, ID_Fahrzeug, ID_Sitze)

#type 21 hat die sitze  "K2ST2" "K2LE2"
bauteile_sitze1_typ21 <- inner_join(bestandteile_sitze_K2LE2, bestandteile_Typ21, by = c("ID_K2LE2" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2LE2) %>%
  select(ID_T16, ID_T19, ID_T20, ID_Fahrzeug, ID_Sitze)

bauteile_sitze2_typ21 <- inner_join(bestandteile_sitze_K2ST2, bestandteile_Typ21, by = c("ID_K2ST2" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2ST2) %>%
  select(ID_T16, ID_T17, ID_T18, ID_Fahrzeug, ID_Sitze)

#type 22 hat die sitze  "K2ST2" "K2LE2"
bauteile_sitze1_typ22 <- inner_join(bestandteile_sitze_K2LE2, bestandteile_Typ22, by = c("ID_K2LE2" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2LE2) %>%
  select(ID_T16, ID_T19, ID_T20, ID_Fahrzeug, ID_Sitze)

bauteile_sitze2_typ22 <- inner_join(bestandteile_sitze_K2ST2, bestandteile_Typ22, by = c("ID_K2ST2" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2ST2) %>%
  select(ID_T16, ID_T17, ID_T18, ID_Fahrzeug, ID_Sitze)


#matching motoren
#type 11 hat die motoren "K1BE1" "K1DI1
bauteile_motor1_typ11 <- inner_join(bestandteile_motor_K1BE1, bestandteile_Typ11, by = c("ID_K1BE1" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1BE1) %>%
  select(ID_T1, ID_T2, ID_T3, ID_T4, ID_Fahrzeug, ID_Motor)

bauteile_motor2_typ11 <- inner_join(bestandteile_motor_K1DI1, bestandteile_Typ11, by = c("ID_K1DI1" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1DI1) %>%
  select(ID_T1, ID_T2, ID_T5, ID_T6, ID_Fahrzeug, ID_Motor)

#type 12 hat die motoren "K1BE1" "K1DI1
bauteile_motor1_typ12 <- inner_join(bestandteile_motor_K1BE1, bestandteile_Typ12, by = c("ID_K1BE1" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1BE1) %>%
  select(ID_T1, ID_T2, ID_T3, ID_T4, ID_Fahrzeug, ID_Motor)

bauteile_motor2_typ12 <- inner_join(bestandteile_motor_K1DI1, bestandteile_Typ12, by = c("ID_K1DI1" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1DI1) %>%
  select(ID_T1, ID_T2, ID_T5, ID_T6, ID_Fahrzeug, ID_Motor)

#type 21 hat die motoren "K1BE2" "K1DI2"
bauteile_motor1_typ21 <- inner_join(bestandteile_motor_K1BE2, bestandteile_Typ21, by = c("ID_K1BE2" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1BE2) %>%
  select(ID_T1, ID_T2, ID_T7, ID_T8, ID_Fahrzeug, ID_Motor)

bauteile_motor2_typ21 <- inner_join(bestandteile_motor_K1DI2, bestandteile_Typ12, by = c("ID_K1DI2" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1DI2) %>%
  select(ID_T1, ID_T2, ID_T9, ID_T10, ID_Fahrzeug, ID_Motor)


#type 22 hat die motoren "K1BE2" "K1DI2"
bauteile_motor1_typ22 <- inner_join(bestandteile_motor_K1BE2, bestandteile_Typ22, by = c("ID_K1BE2" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1BE2) %>%
  select(ID_T1, ID_T2, ID_T7, ID_T8, ID_Fahrzeug, ID_Motor)

bauteile_motor2_typ22 <- inner_join(bestandteile_motor_K1DI2, bestandteile_Typ22, by = c("ID_K1DI2" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1DI2) %>%
  select(ID_T1, ID_T2, ID_T9, ID_T10, ID_Fahrzeug, ID_Motor)

```


#Erstellen von dataframes für jeden Fahrzeugtyp

Erstellen von Dataframes für jeden Fahrzeugtyp mit allen Einzelteil-Ids.
```{r, message=FALSE, warning = FALSE, cache = TRUE}

#Erstellen von Bestandteilen dataframe Typ 11
all_ids_typ11 <- full_join(bauteile_carosserie_typ11, bauteile_schaltung1_typ11, by = "ID_Fahrzeug") %>%
  full_join(bauteile_schaltung2_typ11, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze1_typ11, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze2_typ11,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor1_typ11,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor2_typ11,by = "ID_Fahrzeug")

#entfernen von überflüssigen Spalten
all_ids_typ11 <- select(all_ids_typ11, -ID_Karosserie, -ID_Schaltung.x,-ID_Schaltung.y,-ID_Sitze.x,-ID_Sitze.y,-ID_Motor.x,-ID_Motor.y)
# Zusammenführen der Spalten a.x und a.y in eine neue Spalte a
all_ids_typ11 = merge_columns(all_ids_typ11)


#Erstellen von Bestandteilen dataframe Typ 12
all_ids_typ12 <- full_join(bauteile_carosserie_typ12, bauteile_schaltung1_typ12, by = "ID_Fahrzeug") %>%
  full_join(bauteile_schaltung2_typ12, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze1_typ12, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze2_typ12,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor1_typ12,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor2_typ12,by = "ID_Fahrzeug")

all_ids_typ12 <- select(all_ids_typ12, -ID_Karosserie, -ID_Schaltung.x,-ID_Schaltung.y,-ID_Sitze.x,-ID_Sitze.y,-ID_Motor.x,-ID_Motor.y)
# Zusammenführen der Spalten a.x und a.y in eine neue Spalte a
all_ids_typ12 = merge_columns(all_ids_typ12)


#Erstellen von Bestandteilen dataframe Typ 21
all_ids_typ21 <- full_join(bauteile_carosserie_typ21, bauteile_schaltung1_typ21, by = "ID_Fahrzeug") %>%
  full_join(bauteile_schaltung2_typ21, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze1_typ21, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze2_typ21,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor1_typ21,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor2_typ21,by = "ID_Fahrzeug")

all_ids_typ21 <- select(all_ids_typ21, -ID_Karosserie, -ID_Schaltung.x,-ID_Schaltung.y,-ID_Sitze.x,-ID_Sitze.y,-ID_Motor.x,-ID_Motor.y)
# Zusammenführen der Spalten a.x und a.y in eine neue Spalte a
all_ids_typ21 = merge_columns(all_ids_typ21)


#Erstellen von Bestandteilen dataframe Typ 22
all_ids_typ22 <- full_join(bauteile_carosserie_typ22, bauteile_schaltung1_typ22, by = "ID_Fahrzeug") %>%
  full_join(bauteile_schaltung2_typ22, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze1_typ22, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze2_typ22,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor1_typ22,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor2_typ22,by = "ID_Fahrzeug")

all_ids_typ22 <- select(all_ids_typ22, -ID_Karosserie, -ID_Schaltung.x,-ID_Schaltung.y,-ID_Sitze.x,-ID_Sitze.y,-ID_Motor.x,-ID_Motor.y)
# Zusammenführen der Spalten a.x und a.y in eine neue Spalte a
all_ids_typ22 = merge_columns(all_ids_typ22)

```


#Erstellen eines großen Dataframes, der für alle enthaltenen Einzelteile
```{r, message=FALSE, warning = FALSE, cache = TRUE}
all_df_data <- bind_rows(all_ids_typ11,all_ids_typ12,all_ids_typ21,all_ids_typ22)
#rumbenennen von Spalten
names(all_df_data)[names(all_df_data) == "ID_T1"] <- "ID_T01"
names(all_df_data)[names(all_df_data) == "ID_T2"] <- "ID_T02"
names(all_df_data)[names(all_df_data) == "ID_T3"] <- "ID_T03"
names(all_df_data)[names(all_df_data) == "ID_T4"] <- "ID_T04"
names(all_df_data)[names(all_df_data) == "ID_T5"] <- "ID_T05"
names(all_df_data)[names(all_df_data) == "ID_T6"] <- "ID_T06"
names(all_df_data)[names(all_df_data) == "ID_T7"] <- "ID_T07"
names(all_df_data)[names(all_df_data) == "ID_T8"] <- "ID_T08"
names(all_df_data)[names(all_df_data) == "ID_T9"] <- "ID_T09"
glimpse(all_df_data)
```




## Einzelteile einlesen 

#1 Einzelteil T01 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}

path = "Data/Einzelteil/Einzelteil/Einzelteil_T01.txt"
txt <- readLines(path)
txt <- gsub(" | | ",",",txt, fixed = TRUE)
txt <- gsub(" ","\n",txt, fixed = TRUE)
part_T01 <- fread(text = txt, sep = ",", data.table = FALSE, drop=c(1,2)) %>% 
  filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1 | Fehlerhaft == 1 ) &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 

#anpassen von Verdoppelungen
part_T01 = merge_columns(part_T01)
names(part_T01)[names(part_T01) == "Fehlerhaft_Datum"] <- "Fehlerhaft_Datum_T01"
names(part_T01)[names(part_T01) == "Fehlerhaft_Fahrleistung"] <- "Fehlerhaft_Fahrleistung_T01"
glimpse(part_T01)

```


#2 Einzelteil T02 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}

path = "Data/Einzelteil/Einzelteil/Einzelteil_T02.txt"

txt <- readLines(path)
txt <- gsub("  ",",",txt, fixed = TRUE)
txt <- gsub("\t","\n",txt, fixed = TRUE)
part_T02 <- fread(text = txt, sep = ",", data.table = FALSE, drop=c(1,2)) %>% 
  filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 


#anpassen von Verdoppelungen
part_T02 = merge_columns(part_T02)
glimpse(part_T02)

```


#Einzelteil T03 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
txt <- readLines("Data/Einzelteil/Einzelteil/Einzelteil_T03.txt")
txt <- gsub("|",",",txt, fixed = TRUE)
txt <- gsub("\v","\n",txt, fixed = TRUE)
part_T03 <- fread(text = txt, sep = ",", data.table = FALSE) %>% 
  filter((Fehlerhaft== 1) &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016))) 
glimpse(part_T03)

```


#Einzelteil T04 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
  part_T04 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T04.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T04)

```


#Einzelteil T05 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T05 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T05.csv", header = TRUE, data.table = FALSE, drop= c(1,2)) %>% 
 filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016)))
part_T05 = merge_columns(part_T05)
glimpse(part_T05)


```


#6 Einzelteil T06 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T06 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T06.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T06)


```
#7 Einzelteil T07 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
txt <- readLines("Data/Einzelteil/Einzelteil/Einzelteil_T07.txt")
txt <- gsub("\"\t\"",",",txt)
txt <- gsub("\"\t",",",txt)
txt <- gsub("\t\"",",",txt)
txt <- gsub("\t",",",txt)
txt <- gsub("\"\"","\n",txt)
txt <- gsub("\"","\n",txt)
part_T07 <- fread(text = txt, sep = ",", quote = "", data.table = FALSE) %>% 
  filter((Fehlerhaft == 1) &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016))) 
glimpse(part_T07)



```


#8 Einzelteil T08 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T08 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T08.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T08)

```

#9 Einzelteil T09 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}

#part_T09 <- read_file(paste0(filepath,"Einzelteil/Einzelteil/Einzelteil_T09.txt")) %>%
part_T09 <- read_file("Data/Einzelteil/Einzelteil/Einzelteil_T09.txt") %>% 
  str_replace_all('\\\"', '') %>%
  str_replace_all('\\\\', ',') %>%
  str_replace_all('\v','\n')
part_T09 <- fread(part_T09, sep =",", drop = c(1,2)) %>%
 filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 

part_T09 = merge_columns(part_T09)
glimpse(part_T09)
```

#10 Einzelteil T10 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T10 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T10.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T10)
```

#11 Einzelteil T11 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
txt <- readLines("Data/Einzelteil/Einzelteil/Einzelteil_T11.txt")
txt <- gsub("\t", ",", txt, fixed = TRUE)
txt <- gsub("\f", "\n", txt, fixed = TRUE)
part_T11 <- fread(text = txt, sep = ",", data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 & 
           year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016) 
glimpse(part_T11)
```


#12 Einzelteil T12 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T12 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T12.csv", header = TRUE, data.table = FALSE, drop = c(1,2)) %>% 
    filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1 | Fehlerhaft == 1 ) &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016)))
part_T12 = merge_columns(part_T12)
glimpse(part_T12)
```


#13 Einzelteil T13 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T13 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T13.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T13)
```


#14 Einzelteil T14 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T14 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T14.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T14)
```


#15 Einzelteil T15 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T15 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T15.csv", header = TRUE, data.table = FALSE, drop= c(1,2)) %>% 
 filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016)))
part_T15 = merge_columns(part_T15)
glimpse(part_T15)
```


#16 Einzelteil T16 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#part_T16 <- read_file(paste0(filepath,"Einzelteil/Einzelteil/Einzelteil_T16.txt")) %>%
#part_T16 <- read_file("Data/Einzelteil/Einzelteil/Einzelteil_T16.txt") %>%
part_T16 <- read_file("Data/Einzelteil/Einzelteil/Einzelteil_T16.txt") %>%
  str_replace_all(" \\| \\| ", ",") %>%
  str_replace_all("\t","\n")
part_T16 <- fread(part_T16, sep =",", drop = c(1,2)) %>%
  filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1 | Fehlerhaft == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016)))
part_T16 = merge_columns(part_T16)
glimpse(part_T16)
```


#17 Einzelteil T17 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T17 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T17.csv", header = TRUE, data.table = FALSE, drop = c(1,2)) %>% 
  filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1 | Fehlerhaft == 1 ) &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016)))
part_T17 = merge_columns(part_T17)
glimpse(part_T17)
```


#18 Einzelteil T18 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T18 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T18.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T18)
```


#19 Einzelteil T19 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T19 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T19.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T19)
```


#20 Einzelteil T20 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#txt <- readLines(paste0(filepath,"Einzelteil/Einzelteil/Einzelteil_T20.txt"))
txt <- readLines("Data/Einzelteil/Einzelteil/Einzelteil_T20.txt")
txt <- gsub(" | | ",",",txt, fixed = TRUE)
txt <- gsub(" ","\n",txt, fixed = TRUE)
part_T20 <- fread(text = txt, sep = ",", data.table = FALSE, drop = c(1,2,10)) %>% 
    filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T20)
```


21 Einzelteil T21 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T21 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T21.csv", header = TRUE, data.table = FALSE,drop = c(1,2,10)) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T21)
```


#22 Einzelteil T22 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}

txt <- readLines("Data/Einzelteil/Einzelteil/Einzelteil_T22.txt")
txt <- gsub("\"\t\"", ",", txt)
txt <- gsub("\"\t", ",", txt)
txt <- gsub("\t\"", ",", txt)
txt <- gsub("\t", ",", txt)
txt <- gsub("\"\"", "\n", txt)
txt <- gsub("\"", "\n", txt)

part_T22 <- fread(text = txt, sep = ",", data.table = FALSE, drop = c(1, 2, 10)) %>% 
  filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1 | Fehlerhaft == 1) &
           ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016) |
            (year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
            (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016)))

part_T22 = merge_columns(part_T22)
glimpse(part_T22)
```


#23 Einzelteil T23 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T23 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T23.csv", header = TRUE, data.table = FALSE,drop = c(1,2)) %>% 
 filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 
part_T23 = merge_columns(part_T23)
glimpse(part_T23)

```


#24 Einzelteil T24 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
txt <- readLines("Data/Einzelteil/Einzelteil/Einzelteil_T24.txt")
txt <- gsub("  ",",",txt, fixed = TRUE)
txt <- gsub("\f","\n",txt, fixed = TRUE)
part_T24 <- fread(text = txt, sep = ",", data.table = FALSE, drop =c(1,2)) %>% 
 filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 
part_T24 = merge_columns(part_T24)
glimpse(part_T24)
```


25 Einzelteil T25 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T25 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T25.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T25)
```


#26 Einzelteil T26 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T26 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T26.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T26)
```


#27 Einzelteil T27 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#part_T27 <- read_file(paste0(filepath,"Einzelteil/Einzelteil/Einzelteil_T27.txt")) %>%
part_T27 <- read_file("Data/Einzelteil/Einzelteil/Einzelteil_T27.txt")%>%
  str_replace_all(" \\| \\| ", ",") %>%
  str_replace_all("\a", "\n") 
part_T27 <- fread(part_T27, sep =",", drop = c(1,2))%>%
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T27)
```


#30 Einzelteil T30 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T30 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T30.csv", header = TRUE, data.table = FALSE) %>% 
   filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1 | Fehlerhaft == 1 ) &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 
part_T30 = merge_columns(part_T30)
glimpse(part_T30)
```


#31 Einzelteil T31 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
txt <- readLines("Data/Einzelteil/Einzelteil/Einzelteil_T31.txt")
txt <- gsub("  ",",",txt, fixed = TRUE)
txt <- gsub("\b","\n",txt, fixed = TRUE)
part_T31 <- fread(text = txt, sep = ",", data.table = FALSE, drop = c(1,2)) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T31)
```


#32 Einzelteil T32 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T32 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T32.csv", header = TRUE, data.table = FALSE, drop = c(1.2)) %>% 
 filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 

part_T32 = merge_columns(part_T32)
glimpse(part_T32)
```


#33 Einzelteil T33 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T33 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T33.csv", header = TRUE, data.table = FALSE) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T33)
```


#34 Einzelteil T34 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T34 <- read_file("Data/Einzelteil/Einzelteil/Einzelteil_T34.txt") %>%
  str_replace_all(" \\| \\| ", ",") %>%
  str_replace_all("\"\"", "\"\n\"")
part_T34 <- fread(part_T34, sep = ",", data.table = FALSE, drop = c(1,2,10)) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T34)
```


#35 Einzelteil T35 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T35 <- read_file("Data/Einzelteil/Einzelteil/Einzelteil_T35.txt") %>%
  str_replace_all("\\\\", ", ") %>%
  str_replace_all("(?<=\\S)(\"\\d+\")", "\n")
part_T35 <- fread(part_T35, sep = ",", drop = c(1,2))%>%
 filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016)))
part_T35 = merge_columns(part_T35)
glimpse(part_T35)
```


#36 Einzelteil T36 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
# Dateipfad zur Textdatei
dateipfad <- "Data/Einzelteil/Einzelteil/Einzelteil_T36.txt"

# Einlesen der Textdatei als reine Zeichenfolge
text <- read_file(dateipfad)

text <- gsub("\"", "", text)

rowlist <- scan(dateipfad, what = character(), sep = "")

list <- rowlist[11:length(rowlist)]

part_T36 <- matrix(list, nrow = length(list)/10, ncol = 10, byrow = TRUE)

colnames(part_T36) <- c(rowlist[1],rowlist[2], rowlist[3], rowlist[4], rowlist[5], rowlist[6], rowlist[7], rowlist[8], rowlist[9],rowlist[10])

part_T36 <- data.frame(part_T36) %>%
  filter(part_T36[,5] == "1" &
           ((year(as.Date(part_T36[,6])) >= 2014 & year(as.Date(part_T36[,6])) <= 2016)))

glimpse(part_T36)
```


#37 Einzelteil T37 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T37 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T37.csv", header = TRUE, data.table = FALSE, drop = c(1,2,10)) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
glimpse(part_T37)
```


#38 Einzelteil T38 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T38 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T38.csv", header = TRUE, data.table = FALSE, drop = c(1,2)) %>% 
 filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 
part_T38 = merge_columns(part_T38)
glimpse(part_T38)
```


#39 Einzelteil T39 einlesen
```{r message=FALSE, warning=FALSE, cache=FALSE}
part_T39 <- read_file("Data/Einzelteil/Einzelteil/Einzelteil_T39.txt") %>%
  str_replace_all("\\\\", ",") %>%
  str_replace_all("\a", "\n") 
part_T39 <- fread(part_T39, sep = ",", drop = c(1,2)) %>%
  filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016)))

part_T39 = merge_columns(part_T39)
glimpse(part_T39)
```


#40 Einzelteil T40 einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
part_T40 <- fread("Data/Einzelteil/Einzelteil/Einzelteil_T40.csv", header = TRUE, data.table = FALSE, drop = c(1,2,10)) %>% 
  filter(Fehlerhaft == 1 &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016)))
part_T40 = merge_columns(part_T40)
glimpse(part_T40)
```



## Erstellen des finalen Datensates


#Erstellen des ersten finalen dataframes für T01

Das Vorgehen ist hierbei so, dass der finale Dataframe iterativ erstellt wird.
Dafür wird zunächst der finale Dataframe für T01 erstellt.
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#erstelle einen neued df mit spalten des alten
selection_part_T01 <- select(part_T01,ID_T01,Fehlerhaft_Datum_T01, Fehlerhaft_Fahrleistung_T01)
glimpse(selection_part_T01)

#erstelle einen neued df mit spalten des alten
#wähle spalten aus gesamt df aus
all_df_selection_T01 <- select(all_df_data,ID_Fahrzeug, ID_T01)
glimpse(all_df_selection_T01)
#entferne na values aus df  für schnelleres matchen
#hier müssen wir auf jeden fall nochmal schauen, ob zu viele werte entfernt werden
all_df_selection_T01 <- na.omit(all_df_selection_T01)
glimpse(all_df_selection_T01)

#zusammenfügen der dataframes
final_df_T01 <- inner_join(all_df_selection_T01, selection_part_T01, by = "ID_T01")
#entferne alle na values
#hier müssen wir auf jeden fall nochmal schauen, ob zu viele werte entfernt werden
glimpse(final_df_T01)
```



```{r, message=FALSE, warning = FALSE, cache = TRUE}

#als vorbereitungsschritt wird hier final_df als final_df_t01 initialisiert
final_df = final_df_T01


part_list <- sprintf("T%02d", 2:40)
zu_entfernen <- c("T28", "T29")

# Entfernen der spezifischen Elemente und Aktualisieren der Liste
part_list <- setdiff(part_list, zu_entfernen)



print(part_list)

for(part_name in part_list) {
  
  #umbennen der spalten - neuer name
  fehlerhaft_datum_name <- paste0("Fehlerhaft_Datum_", part_name)
 # fehlerhaft_fahrleistung_name <- paste0("Fehlerhaft_Fahrleistung_", part_name)
  
  #definieren der teile ID
  id_name <- paste0("ID_", part_name)
  
  df_name <- paste0("part_", part_name)
  
  #öffne den df wenn er exisitert
  part_df <- get(df_name)
  
  # Umbenennen der Spalten im part_df
  part_df <- part_df %>%
    rename(!!fehlerhaft_datum_name := Fehlerhaft_Datum)#,
          # !!fehlerhaft_fahrleistung_name := Fehlerhaft_Fahrleistung)
  
 # print(df_name)
  #glimpse(part_df)
  

  # das hier basiert alles auf dem geloopten namen  
  
  # Auswahl spezifischer Spalten
  selection_part <- select(part_df, !!id_name, !!fehlerhaft_datum_name)#, !!fehlerhaft_fahrleistung_name)
  
  # Auswahl und Bereinigung im all_df_data
  all_df_selection <- select(all_df_data, ID_Fahrzeug, !!id_name) %>%
    na.omit()
  
  # Zusammenführen der DataFrames
  final_df_part <- inner_join(all_df_selection, selection_part, by = id_name)
  
  #das hier muss sowohl auf dem geloopten, als auch auf dem final df basieren
  final_df <- full_join(final_df, final_df_part, by = "ID_Fahrzeug")
  
  #write.csv(final_df, "final_df", row.names = TRUE)
  
 # glimpse(final_df)
}
```

# Erstellen des finalen Datensatzes

Im nachfolgenden Abschnitt wird der finale Datensatz zunächst erstellt und anschließend
```{r, message=FALSE, warning = FALSE, cache = TRUE}

finaler_dataframe <- inner_join(final_df,fahrzeuge_ges_filtered_years_geo, by = "ID_Fahrzeug")

write.csv(finaler_dataframe, "finaler_Datensatz_CaseStudy.csv", row.names = TRUE)



```



