---
  title: "Case Study Group 7"
author: "Timon Zimmermann, Lüko Neuner-Jehle, Johannes Florstedt, Enis XXX, Hendrik Dybus"
date: "07.02.2024"
output: 
  html_document:
  toc: true
toc_float: true
code_folding: hide
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Bibliothek
Für die Durchführung der folgenden datengestützten Analyse sind mehrere **R-Pakete** erforderlich.

```{r, message=FALSE, warning = FALSE, cache = TRUE}
#Installation und Laden des Pakets "install.load", falls erforderlich. 
# Hinweis: Das "install.load"-Paket enthält die Funktion install_load.

if(!require(install.load)){
  install.packages("install.load")
  library(install.load)
}

# Installation und Laden der genannten Pakete, falls erforderlich   
install_load("dplyr", "readr", "data.table",  "shiny", "tidyr", "DT", "ggplot2")

print("hallo")
```
# Lese Zulassungen aller Fahrzeuge als erste Datei ein

```{r, message=FALSE, warning = FALSE, cache = TRUE}
zulassungen_filtered <- fread("C:/Users/lueko/Data Science/Data/Zulassungen_alle_Fahrzeuge.csv", header = TRUE, data.table = FALSE, encoding = "Latin-1" ) %>% 
  filter(tolower(Gemeinden) %in% tolower(c("Koeln", "Dortmund", "Bielefeld", "Bonn", "Oberhausen", "Bochum", "Muenster", "Aachen")))
  #tolower ermöglicht, dass die string sowohl ins capslock, als auch klein oder mischung gefiltert werden

glimpse(zulassungen_filtered)


class(zulassungen_filtered$IDNummer)

```

# Filtere relevante Fahrzeug Ids aus Zulassungen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
fahrzeug_id_zulassungen <- data.frame(IDNummer = zulassungen_filtered$IDNummer)
glimpse(fahrzeug_id_zulassungen)

class(fahrzeug_id_zulassungen)
```
# Lade die Fahrzeugdaten
```{r, message=FALSE, warning = FALSE, cache = TRUE}
# CSV-Datei einlesen
# Import of vehicles type 11
Fahrzeug_Typ11 <- fread("Data/Fahrzeug/Fahrzeuge_OEM1_Typ11.csv", header = TRUE, data.table = FALSE, select =  c("ID_Fahrzeug", "Produktionsdatum", "Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum"))
# Import of vehicles type 12
Fahrzeug_Typ12 <- fread("Data/Fahrzeug/Fahrzeuge_OEM1_Typ12.csv", header = TRUE, data.table = FALSE, select =  c("ID_Fahrzeug", "Produktionsdatum", "Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum"))
# Import of vehicles type 21
Fahrzeug_Typ21 <- fread("Data/Fahrzeug/Fahrzeuge_OEM2_Typ21.csv", header = TRUE, data.table = FALSE, select =  c("ID_Fahrzeug", "Produktionsdatum", "Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum"))
# Import of vehicles type 22
Fahrzeug_Typ22 <- fread("Data/Fahrzeug/Fahrzeuge_OEM2_Typ22.csv", header = TRUE, data.table = FALSE, select =  c("ID_Fahrzeug", "Produktionsdatum", "Werksnummer", "Fehlerhaft", "Fehlerhaft_Datum"))
                        
glimpse(Fahrzeug_Typ11)
glimpse(Fahrzeug_Typ12)
glimpse(Fahrzeug_Typ21)
glimpse(Fahrzeug_Typ22)

```
# Daten nach den IDs in fahrzeug_id_zulassungen filtern
```{r, message=FALSE, warning = FALSE, cache = TRUE}
oem_typ11_filtered <- Fahrzeug_Typ11 %>%
  filter(ID_Fahrzeug %in% fahrzeug_id_zulassungen$IDNummer)

oem_typ12_filtered <- Fahrzeug_Typ12 %>%
  filter(ID_Fahrzeug %in% fahrzeug_id_zulassungen$IDNummer)

oem_typ21_filtered <- Fahrzeug_Typ21 %>%
  filter(ID_Fahrzeug %in% fahrzeug_id_zulassungen$IDNummer)

oem_typ22_filtered <- Fahrzeug_Typ22 %>%
  filter(ID_Fahrzeug %in% fahrzeug_id_zulassungen$IDNummer)

glimpse(oem_typ11_filtered)
glimpse(oem_typ12_filtered)
glimpse(oem_typ21_filtered)
glimpse(oem_typ22_filtered)
```
# filtere nach fehlerhaften Fahrzeugen
```{r, message=FALSE, warning = FALSE, cache = TRUE}

oem_typ11_fehlerhaft <- oem_typ11_filtered %>%
  filter(Fehlerhaft == 1)

oem_typ12_fehlerhaft <- oem_typ12_filtered %>%
  filter(Fehlerhaft == 1)

oem_typ21_fehlerhaft <- oem_typ21_filtered %>%
  filter(Fehlerhaft == 1)

oem_typ22_fehlerhaft <- oem_typ22_filtered %>%
  filter(Fehlerhaft == 1)


glimpse(oem_typ11_fehlerhaft)
glimpse(oem_typ12_fehlerhaft)
glimpse(oem_typ21_fehlerhaft)
glimpse(oem_typ22_fehlerhaft)
```

# filtere nach benötigten Jahren
```{r, message=FALSE, warning = FALSE, cache = TRUE}
# Auswahl der Spalten "ID_Fahrzeug" und "Fehlerhaft_Datum" aus jedem Dataframe
oem_typ11_auswahl <- select(oem_typ11_fehlerhaft, ID_Fahrzeug, Fehlerhaft_Datum)
oem_typ12_auswahl <- select(oem_typ12_fehlerhaft, ID_Fahrzeug, Fehlerhaft_Datum)
oem_typ21_auswahl <- select(oem_typ21_fehlerhaft, ID_Fahrzeug, Fehlerhaft_Datum)
oem_typ22_auswahl <- select(oem_typ22_fehlerhaft, ID_Fahrzeug, Fehlerhaft_Datum)

# Zusammenführen der ausgewählten Dataframes zu einem neuen Dataframe
fahrzeuge_gesamt_filtered <- bind_rows(oem_typ11_auswahl, oem_typ12_auswahl, oem_typ21_auswahl, oem_typ22_auswahl)
glimpse(fahrzeuge_gesamt_filtered)

# Stellen Sie sicher, dass 'Fehlerhaft_Datum' als Datum interpretiert wird
fahrzeuge_gesamt_filtered$Fehlerhaft_Datum <- as.Date(fahrzeuge_gesamt_filtered$Fehlerhaft_Datum)

# Datensatz nach den Jahren 2014 bis einschließlich 2016 filtern
fahrzeuge_ges_filtered_years <- fahrzeuge_gesamt_filtered %>%
  filter(year(Fehlerhaft_Datum) >= 2014 & year(Fehlerhaft_Datum) <= 2016)

glimpse(fahrzeuge_ges_filtered_years)
```
# Fahrzeug Bestandteile auslesen neu
```{r, message=FALSE, warning = FALSE, cache = TRUE}
bestandteile_Typ11 <- fread("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ11.csv", header = TRUE, data.table = FALSE)
bestandteile_Typ12 <- fread("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ12.csv", header = TRUE, data.table = FALSE)
bestandteile_Typ21 <- fread("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM2_Typ21.csv", header = TRUE, data.table = FALSE)
bestandteile_Typ22 <- fread("Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM2_Typ22.csv", header = TRUE, data.table = FALSE)

#die Ids selbst sind in der jeweiligen column
carosserie_Ids_11_key = unique(sapply(strsplit(bestandteile_Typ11$ID_Karosserie, "-"), `[`, 1))
schaltung_Ids_11_key = unique(sapply(strsplit(bestandteile_Typ11$ID_Schaltung, "-"), `[`, 1))
sitze_Ids_11_key = unique(sapply(strsplit(bestandteile_Typ11$ID_Sitze, "-"), `[`, 1))
motor_Ids_11_key = unique(sapply(strsplit(bestandteile_Typ11$ID_Motor, "-"), `[`, 1))

#hier kann man eine Prüfung durchführen, ob die Länge von unique immer 1 ist um klar zu zuweisen, dass es immer nur 1 gibt
print(carosserie_Ids_11_key)
print(schaltung_Ids_11_key)
print(sitze_Ids_11_key)
print(motor_Ids_11_key)

#die Ids selbst sind in der jeweiligen column
carosserie_Ids_12_key = unique(sapply(strsplit(bestandteile_Typ12$ID_Karosserie, "-"), `[`, 1))
schaltung_Ids_12_key = unique(sapply(strsplit(bestandteile_Typ12$ID_Schaltung, "-"), `[`, 1))
sitze_Ids_12_key = unique(sapply(strsplit(bestandteile_Typ12$ID_Sitze, "-"), `[`, 1))
motor_Ids_12_key = unique(sapply(strsplit(bestandteile_Typ12$ID_Motor, "-"), `[`, 1))

#hier kann man eine Prüfung durchführen, ob die Länge von unique immer 1 ist um klar zu zuweisen, dass es immer nur 1 gibt
print(carosserie_Ids_12_key)
print(schaltung_Ids_12_key)
print(sitze_Ids_12_key)
print(motor_Ids_12_key)


#die Ids selbst sind in der jeweiligen column
carosserie_Ids_21_key = unique(sapply(strsplit(bestandteile_Typ21$ID_Karosserie, "-"), `[`, 1))
schaltung_Ids_21_key = unique(sapply(strsplit(bestandteile_Typ21$ID_Schaltung, "-"), `[`, 1))
sitze_Ids_21_key = unique(sapply(strsplit(bestandteile_Typ21$ID_Sitze, "-"), `[`, 1))
motor_Ids_21_key = unique(sapply(strsplit(bestandteile_Typ21$ID_Motor, "-"), `[`, 1))

#hier kann man eine Prüfung durchführen, ob die Länge von unique immer 1 ist um klar zu zuweisen, dass es immer nur 1 gibt
print(carosserie_Ids_21_key)
print(schaltung_Ids_21_key)
print(sitze_Ids_21_key)
print(motor_Ids_21_key)


#die Ids selbst sind in der jeweiligen column
carosserie_Ids_22_key = unique(sapply(strsplit(bestandteile_Typ22$ID_Karosserie, "-"), `[`, 1))
schaltung_Ids_22_key = unique(sapply(strsplit(bestandteile_Typ22$ID_Schaltung, "-"), `[`, 1))
sitze_Ids_22_key = unique(sapply(strsplit(bestandteile_Typ22$ID_Sitze, "-"), `[`, 1))
motor_Ids_22_key = unique(sapply(strsplit(bestandteile_Typ22$ID_Motor, "-"), `[`, 1))

#hier kann man eine Prüfung durchführen, ob die Länge von unique immer 1 ist um klar zu zuweisen, dass es immer nur 1 gibt
print(carosserie_Ids_22_key)
print(schaltung_Ids_22_key)
print(sitze_Ids_22_key)
print(motor_Ids_22_key)
```
#komponenten einlesen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
# wir lesen hierzu mit endswith die jeweils erforderlichen Dateien ein
# anschließend kann man entsprechend für jeden Fahrzeugtyp die entsprechenden Bestandteile und später auch die entsprechenden Einzelteile zuweisen

bestandteile_motor_K1BE1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K1BE1.csv", header = TRUE, data.table = FALSE)

bestandteile_motor_K1BE2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K1BE2.csv", header = TRUE, data.table = FALSE)

bestandteile_motor_K1DI1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K1DI1.csv", header = TRUE, data.table = FALSE)

bestandteile_motor_K1DI2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K1DI2.csv", header = TRUE, data.table = FALSE)

bestandteile_sitze_K2LE1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K2LE1.csv", header = TRUE, data.table = FALSE)

bestandteile_sitze_K2LE2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K2LE2.csv", header = TRUE, data.table = FALSE)

bestandteile_sitze_K2ST1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K2ST1.csv", header = TRUE, data.table = FALSE)

bestandteile_sitze_K2ST2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K2ST2.csv", header = TRUE, data.table = FALSE)

bestandteile_schaltung_K3AG1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K3AG1.csv", header = TRUE, data.table = FALSE)

bestandteile_schaltung_K3AG2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K3AG2.csv", header = TRUE, data.table = FALSE)

bestandteile_schaltung_K3SG1 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K3SG1.csv", header = TRUE, data.table = FALSE)

bestandteile_schaltung_K3SG2 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K3SG2.csv", header = TRUE, data.table = FALSE)

bestandteile_carosserie_K4 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K4.csv", header = TRUE, data.table = FALSE)

bestandteile_carosserie_K5 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K5.csv", header = TRUE, data.table = FALSE)

bestandteile_carosserie_K6 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K6.csv", header = TRUE, data.table = FALSE)

bestandteile_carosserie_K7 <-fread("Data/Komponente/Komponente/Bestandteile_Komponente_K7.csv", header = TRUE, data.table = FALSE)


```
#aus komponenten die Bestandteile der Kompoenente matchen--> Einzelteil IDs 
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#basierend auf dem vorletzten schritt können nun die entsprechenden dataframes gemachted werden
#über die zuvor identifizierten "unique keys" können wird gematched

print(colnames(bestandteile_Typ12))

glimpse(bestandteile_Typ12)



```
#aus komponenten die Bestandteile der Kompoenente matchen--> Einzelteil IDs 
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#basierend auf dem vorletzten schritt können nun die entsprechenden dataframes gemachted werden
#über die zuvor identifizierten "unique keys" können wird gematched
#man hätte es auch ohne eine aufschlüsselung in die einzelnen Fahrzeugtypen machen könnnen, allerdings sind auf diesem Weg mehr Informationen vorhanden
#würde auch gehen, wenn man den gropen Datensatz nimmmt und die Fahrzeug IDs behält

#nutze semi join, da nur daten von 2. df benötigt werden
#jeder typ hat eine andere karosserie


# matching karosserie types
bauteile_carosserie_typ11 <- inner_join(bestandteile_carosserie_K4, bestandteile_Typ11, by = c("ID_K4" = "ID_Karosserie")) %>%
  #renaming to have a column called ID_Karosserie instead of ID_K4
  rename(ID_Karosserie = ID_K4) %>%
  # Auswählen der gewünschten Spalten
  select(ID_T30, ID_T31, ID_T32, ID_Fahrzeug, ID_Karosserie)

bauteile_carosserie_typ12 <- inner_join(bestandteile_carosserie_K5, bestandteile_Typ12, by = c("ID_K5" = "ID_Karosserie")) %>%
  rename(ID_Karosserie = ID_K5) %>%
  select(ID_T30, ID_T31, ID_T33, ID_Fahrzeug, ID_Karosserie)

bauteile_carosserie_typ21 <- inner_join(bestandteile_carosserie_K6, bestandteile_Typ21, by = c("ID_K6" = "ID_Karosserie"))%>%
  rename(ID_Karosserie = ID_K6) %>%
  select(ID_T34, ID_T35, ID_T36,ID_T37, ID_Fahrzeug, ID_Karosserie)

bauteile_carosserie_typ22 <- inner_join(bestandteile_carosserie_K7, bestandteile_Typ22, by = c("ID_K7" = "ID_Karosserie"))%>%
  rename(ID_Karosserie = ID_K7) %>%
  select(ID_T34, ID_T35, ID_T38,ID_T39,ID_T40, ID_Fahrzeug, ID_Karosserie)


#matching
#typ 11 hat "K3SG1" "K3AG1"als schaltungen
bauteile_schaltung1_typ11 <- inner_join(bestandteile_schaltung_K3AG1, bestandteile_Typ11, by = c("ID_K3AG1" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3AG1) %>%
  select(ID_T21, ID_T24, ID_T25, ID_Fahrzeug, ID_Schaltung)

bauteile_schaltung2_typ11 <- inner_join(bestandteile_schaltung_K3SG1, bestandteile_Typ11, by = c("ID_K3SG1" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3SG1) %>%
  select(ID_T21, ID_T22, ID_T23, ID_Fahrzeug, ID_Schaltung)

#typ 12 hat "K3SG1" "K3AG1"als Schaltungen
bauteile_schaltung1_typ12 <- inner_join(bestandteile_schaltung_K3AG1, bestandteile_Typ12, by = c("ID_K3AG1" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3AG1) %>%
  select(ID_T21, ID_T24, ID_T25, ID_Fahrzeug, ID_Schaltung)

bauteile_schaltung2_typ12 <- inner_join(bestandteile_schaltung_K3SG1, bestandteile_Typ12, by = c("ID_K3SG1" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3SG1) %>%
  select(ID_T21, ID_T22, ID_T23, ID_Fahrzeug, ID_Schaltung)

#type 21 hat "K3AG2" "K3SG2" als SChaltungen
bauteile_schaltung1_typ21 <- inner_join(bestandteile_schaltung_K3AG2, bestandteile_Typ21, by = c("ID_K3AG2" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3AG2) %>%
  select(ID_T21, ID_T24, ID_T27, ID_Fahrzeug, ID_Schaltung)

bauteile_schaltung2_typ21 <- inner_join(bestandteile_schaltung_K3SG2, bestandteile_Typ21, by = c("ID_K3SG2" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3SG2) %>%
  select(ID_T21, ID_T22, ID_T26, ID_Fahrzeug, ID_Schaltung)

#type 22 hat "K3AG2" "K3SG2 als Schaltungen
bauteile_schaltung1_typ22 <- inner_join(bestandteile_schaltung_K3AG2, bestandteile_Typ21, by = c("ID_K3AG2" = "ID_Schaltung"))%>%
  rename(ID_Schaltung = ID_K3AG2) %>%
  select(ID_T21, ID_T24, ID_T27, ID_Fahrzeug, ID_Schaltung)

bauteile_schaltung2_typ22 <- inner_join(bestandteile_schaltung_K3SG2, bestandteile_Typ21, by = c("ID_K3SG2" = "ID_Schaltung")) %>%
  rename(ID_Schaltung = ID_K3SG2) %>%
  select(ID_T21, ID_T22, ID_T26, ID_Fahrzeug, ID_Schaltung)


#type 11 hat die sitze "K2LE1" "K2ST1"
bauteile_sitze1_typ11 <- inner_join(bestandteile_sitze_K2LE1, bestandteile_Typ11, by = c("ID_K2LE1" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2LE1) %>%
  select(ID_T11, ID_T14, ID_T15, ID_Fahrzeug, ID_Sitze)

bauteile_sitze2_typ11 <- inner_join(bestandteile_sitze_K2ST1, bestandteile_Typ11, by = c("ID_K2ST1" = "ID_Sitze"))%>%
  rename(ID_Sitze = ID_K2ST1) %>%
  select(ID_T11, ID_T12, ID_T13, ID_Fahrzeug, ID_Sitze)

#type 12 hat die sitze "K2LE1" "K2ST1"
bauteile_sitze1_typ12 <- inner_join(bestandteile_sitze_K2LE1, bestandteile_Typ12, by = c("ID_K2LE1" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2LE1) %>%
  select(ID_T11, ID_T14, ID_T15, ID_Fahrzeug, ID_Sitze)

bauteile_sitze2_typ12 <- inner_join(bestandteile_sitze_K2ST1, bestandteile_Typ12, by = c("ID_K2ST1" = "ID_Sitze"))%>%
  rename(ID_Sitze = ID_K2ST1) %>%
  select(ID_T11, ID_T12, ID_T13, ID_Fahrzeug, ID_Sitze)

#type 21 hat die sitze  "K2ST2" "K2LE2"
bauteile_sitze1_typ21 <- inner_join(bestandteile_sitze_K2LE2, bestandteile_Typ21, by = c("ID_K2LE2" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2LE2) %>%
  select(ID_T16, ID_T19, ID_T20, ID_Fahrzeug, ID_Sitze)

bauteile_sitze2_typ21 <- inner_join(bestandteile_sitze_K2ST2, bestandteile_Typ21, by = c("ID_K2ST2" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2ST2) %>%
  select(ID_T16, ID_T17, ID_T18, ID_Fahrzeug, ID_Sitze)

#type 22 hat die sitze  "K2ST2" "K2LE2"
bauteile_sitze1_typ22 <- inner_join(bestandteile_sitze_K2LE2, bestandteile_Typ22, by = c("ID_K2LE2" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2LE2) %>%
  select(ID_T16, ID_T19, ID_T20, ID_Fahrzeug, ID_Sitze)

bauteile_sitze2_typ22 <- inner_join(bestandteile_sitze_K2ST2, bestandteile_Typ22, by = c("ID_K2ST2" = "ID_Sitze")) %>%
  rename(ID_Sitze = ID_K2ST2) %>%
  select(ID_T16, ID_T17, ID_T18, ID_Fahrzeug, ID_Sitze)


#type 11 hat die motoren "K1BE1" "K1DI1
bauteile_motor1_typ11 <- inner_join(bestandteile_motor_K1BE1, bestandteile_Typ11, by = c("ID_K1BE1" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1BE1) %>%
  select(ID_T1, ID_T2, ID_T3, ID_T4, ID_Fahrzeug, ID_Motor)

bauteile_motor2_typ11 <- inner_join(bestandteile_motor_K1DI1, bestandteile_Typ11, by = c("ID_K1DI1" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1DI1) %>%
  select(ID_T1, ID_T2, ID_T5, ID_T6, ID_Fahrzeug, ID_Motor)

#type 12 hat die motoren "K1BE1" "K1DI1
bauteile_motor1_typ12 <- inner_join(bestandteile_motor_K1BE1, bestandteile_Typ12, by = c("ID_K1BE1" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1BE1) %>%
  select(ID_T1, ID_T2, ID_T3, ID_T4, ID_Fahrzeug, ID_Motor)

bauteile_motor2_typ12 <- inner_join(bestandteile_motor_K1DI1, bestandteile_Typ12, by = c("ID_K1DI1" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1DI1) %>%
  select(ID_T1, ID_T2, ID_T5, ID_T6, ID_Fahrzeug, ID_Motor)

#type 21 hat die motoren "K1BE2" "K1DI2"
bauteile_motor1_typ21 <- inner_join(bestandteile_motor_K1BE2, bestandteile_Typ21, by = c("ID_K1BE2" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1BE2) %>%
  select(ID_T1, ID_T2, ID_T7, ID_T8, ID_Fahrzeug, ID_Motor)

bauteile_motor2_typ21 <- inner_join(bestandteile_motor_K1DI2, bestandteile_Typ12, by = c("ID_K1DI2" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1DI2) %>%
  select(ID_T1, ID_T2, ID_T9, ID_T10, ID_Fahrzeug, ID_Motor)


#type 22 hat die motoren "K1BE2" "K1DI2"
bauteile_motor1_typ22 <- inner_join(bestandteile_motor_K1BE2, bestandteile_Typ22, by = c("ID_K1BE2" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1BE2) %>%
  select(ID_T1, ID_T2, ID_T7, ID_T8, ID_Fahrzeug, ID_Motor)

bauteile_motor2_typ22 <- inner_join(bestandteile_motor_K1DI2, bestandteile_Typ22, by = c("ID_K1DI2" = "ID_Motor")) %>%
  rename(ID_Motor = ID_K1DI2) %>%
  select(ID_T1, ID_T2, ID_T9, ID_T10, ID_Fahrzeug, ID_Motor)

```

#hilfsfunktion zum cleanen von doppelungen)
```{r, message=FALSE, warning = FALSE, cache = TRUE}
merge_columns <- function(df) {
  # Finden aller Spalten, die auf .x enden
  cols_x <- names(df)[grepl("\\.x$", names(df))]
  # Ersetzen von .x mit leerem String, um die Originalnamen zu erhalten
  original_cols <- gsub("\\.x$", "", cols_x)
  
  for (col in original_cols) {
    # Generiere die Namen der .y Spalten basierend auf den .x Spalten
    col_y <- paste0(col, ".y")
    # Überprüfe, ob sowohl .x als auch .y Spalten existieren
    if(col_y %in% names(df)) {
      # Verwende coalesce, um die Spalten zusammenzuführen
      df[[col]] <- coalesce(df[[paste0(col, ".x")]], df[[col_y]])
      # Entferne die ursprünglichen .x und .y Spalten
      df[[paste0(col, ".x")]] <- NULL
      df[[col_y]] <- NULL
    }
  }
  
  return(df)
}

```

#das hier kann man sehr schön als for loop gestalten, habe es aber erstmal hardgecoded
```{r, message=FALSE, warning = FALSE, cache = TRUE}


#c11 <- select(df2, -c(ID_Motor, T5)) # Entfernt T4 und T5 aus df2
all_ids_typ11 <- full_join(bauteile_carosserie_typ11, bauteile_schaltung1_typ11, by = "ID_Fahrzeug") %>%
  full_join(bauteile_schaltung2_typ11, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze1_typ11, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze2_typ11,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor1_typ11,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor2_typ11,by = "ID_Fahrzeug")

all_ids_typ12 <- full_join(bauteile_carosserie_typ12, bauteile_schaltung1_typ12, by = "ID_Fahrzeug") %>%
  full_join(bauteile_schaltung2_typ12, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze1_typ12, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze2_typ12,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor1_typ12,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor2_typ12,by = "ID_Fahrzeug")

all_ids_typ21 <- full_join(bauteile_carosserie_typ21, bauteile_schaltung1_typ21, by = "ID_Fahrzeug") %>%
  full_join(bauteile_schaltung2_typ21, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze1_typ21, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze2_typ21,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor1_typ21,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor2_typ21,by = "ID_Fahrzeug")

all_ids_typ22 <- full_join(bauteile_carosserie_typ22, bauteile_schaltung1_typ22, by = "ID_Fahrzeug") %>%
  full_join(bauteile_schaltung2_typ22, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze1_typ22, by = "ID_Fahrzeug") %>%
  full_join(bauteile_sitze2_typ22,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor1_typ22,by = "ID_Fahrzeug") %>%
  full_join(bauteile_motor2_typ22,by = "ID_Fahrzeug")



```


#cleanen der einzelnen dfs kann man auch sehr schön als loop machen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
all_ids_typ11 <- select(all_ids_typ11, -ID_Karosserie, -ID_Schaltung.x,-ID_Schaltung.y,-ID_Sitze.x,-ID_Sitze.y,-ID_Motor.x,-ID_Motor.y)
# Zusammenführen der Spalten a.x und a.y in eine neue Spalte a
all_ids_typ11 = merge_columns(all_ids_typ11)
glimpse(all_ids_typ11)
```
```{r, message=FALSE, warning = FALSE, cache = TRUE}
all_ids_typ12 <- select(all_ids_typ12, -ID_Karosserie, -ID_Schaltung.x,-ID_Schaltung.y,-ID_Sitze.x,-ID_Sitze.y,-ID_Motor.x,-ID_Motor.y)
# Zusammenführen der Spalten a.x und a.y in eine neue Spalte a
all_ids_typ12 = merge_columns(all_ids_typ12)

glimpse(all_ids_typ12)
```
```{r, message=FALSE, warning = FALSE, cache = TRUE}
all_ids_typ21 <- select(all_ids_typ21, -ID_Karosserie, -ID_Schaltung.x,-ID_Schaltung.y,-ID_Sitze.x,-ID_Sitze.y,-ID_Motor.x,-ID_Motor.y)
# Zusammenführen der Spalten a.x und a.y in eine neue Spalte a
all_ids_typ21 = merge_columns(all_ids_typ21)

glimpse(all_ids_typ21)
```
```{r, message=FALSE, warning = FALSE, cache = TRUE}
all_ids_typ22 <- select(all_ids_typ22, -ID_Karosserie, -ID_Schaltung.x,-ID_Schaltung.y,-ID_Sitze.x,-ID_Sitze.y,-ID_Motor.x,-ID_Motor.y)
# Zusammenführen der Spalten a.x und a.y in eine neue Spalte a
all_ids_typ22 = merge_columns(all_ids_typ22)

glimpse(all_ids_typ22)
```
#combining all dfs to 1 big df
```{r, message=FALSE, warning = FALSE, cache = TRUE}
all_df_data <- bind_rows(all_ids_typ11,all_ids_typ12,all_ids_typ21,all_ids_typ22)
#rename columns
names(all_df_data)[names(all_df_data) == "ID_T1"] <- "ID_T01"
names(all_df_data)[names(all_df_data) == "ID_T2"] <- "ID_T02"
names(all_df_data)[names(all_df_data) == "ID_T3"] <- "ID_T03"
names(all_df_data)[names(all_df_data) == "ID_T4"] <- "ID_T04"
names(all_df_data)[names(all_df_data) == "ID_T5"] <- "ID_T05"
names(all_df_data)[names(all_df_data) == "ID_T6"] <- "ID_T06"
names(all_df_data)[names(all_df_data) == "ID_T7"] <- "ID_T07"
names(all_df_data)[names(all_df_data) == "ID_T8"] <- "ID_T08"
names(all_df_data)[names(all_df_data) == "ID_T9"] <- "ID_T09"
glimpse(all_df_data)
```


## Einzelteile einlesen 
#1  " | | "  " | | "
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#filepath <- "C:/Users/Timon/OneDrive/Dokumente/Case_Study_Gruppe_07/"

#txt <- readLines(paste0(filepath, "Data/Einzelteil/Einzelteil_T01.txt"))
path = "Data/Einzelteil/Einzelteil/Einzelteil_T01.txt"
txt <- readLines(path)
txt <- gsub(" | | ",",",txt, fixed = TRUE)
txt <- gsub(" ","\n",txt, fixed = TRUE)
part_T01 <- fread(text = txt, sep = ",", data.table = FALSE, drop=c(1,2)) %>% 
  filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1 | Fehlerhaft == 1 ) &
         ((year(as.Date(Fehlerhaft_Datum)) >= 2014 & year(as.Date(Fehlerhaft_Datum)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 

#anpassen von Verdoppelungen
part_T01 = merge_columns(part_T01)
names(part_T01)[names(part_T01) == "Fehlerhaft_Datum"] <- "Fehlerhaft_Datum_T01"
names(part_T01)[names(part_T01) == "Fehlerhaft_Fahrleistung"] <- "Fehlerhaft_Fahrleistung_T01"
glimpse(part_T01)

```
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#erstelle einen neued df mit spalten des alten
selection_part_T01 <- select(part_T01,ID_T01,Fehlerhaft_Datum_T01, Fehlerhaft_Fahrleistung_T01)
glimpse(selection_part_T01)

#erstelle einen neued df mit spalten des alten
#wähle spalten aus gesamt df aus
all_df_selection_T01 <- select(all_df_data,ID_Fahrzeug, ID_T01)
glimpse(all_df_selection_T01)
#entferne na values aus df  für schnelleres matchen
#hier müssen wir auf jeden fall nochmal schauen, ob zu viele werte entfernt werden
all_df_selection_T01 <- na.omit(all_df_selection_T01)
glimpse(all_df_selection_T01)

#zusammenfügen der dataframes
final_df_T01 <- inner_join(all_df_selection_T01, selection_part_T01, by = "ID_T01")
#entferne alle na values
#hier müssen wir auf jeden fall nochmal schauen, ob zu viele werte entfernt werden
glimpse(final_df_T01)
#glimpse(all_df_selection_T01_cleaned)
```


#2 zweite datei
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#filepath <- "C:/Users/Timon/OneDrive/Dokumente/Case_Study_Gruppe_07/"

#txt <- readLines(paste0(filepath, "Data/Einzelteil/Einzelteil_T01.txt"))
path = "Data/Einzelteil/Einzelteil/Einzelteil_T02.txt"

txt <- readLines(path)
txt <- gsub("  ",",",txt, fixed = TRUE)
txt <- gsub("\t","\n",txt, fixed = TRUE)
part_T02 <- fread(text = txt, sep = ",", data.table = FALSE, drop=c(1,2)) %>% 
  filter((Fehlerhaft.x == 1 | Fehlerhaft.y == 1) &
         ((year(as.Date(Fehlerhaft_Datum.x)) >= 2014 & year(as.Date(Fehlerhaft_Datum.x)) <= 2016) |
          (year(as.Date(Fehlerhaft_Datum.y)) >= 2014 & year(as.Date(Fehlerhaft_Datum.y)) <= 2016))) 



#anpassen von Verdoppelungen
part_T02 = merge_columns(part_T02)

# Ändern der Spaltennamen im DataFrame part_T02.
part_T02 <- part_T02 %>%
  rename(
    # Die Spalte 'Fehlerhaft_Datum' wird in 'Fehlerhaft_Datum_T02' umbenannt.
    Fehlerhaft_Datum_T02 = Fehlerhaft_Datum,
    # Die Spalte 'Fehlerhaft_Fahrleistung' wird in 'Fehlerhaft_Fahrleistung_T02' umbenannt.
    Fehlerhaft_Fahrleistung_T02 = Fehlerhaft_Fahrleistung)


glimpse(part_T02)

```
#zu dataframe hinzufügen
```{r, message=FALSE, warning = FALSE, cache = TRUE}
#erstelle einen neued df mit spalten des alten
#wähle spalten aus gesamt df aus
selection_part_T02 <- select(part_T02,ID_T02,Fehlerhaft_Datum_T02, Fehlerhaft_Fahrleistung_T02)
glimpse(selection_part_T02)

all_df_selection_T02 <- select(all_df_data,ID_Fahrzeug, ID_T02)
#entferne na values aus df  für schnelleres matchen
#hier müssen wir auf jeden fall nochmal schauen, ob zu viele werte entfernt werden
all_df_selection_T02 <- na.omit(all_df_selection_T02)
glimpse(all_df_selection_T02)

#zusammenfügen der dataframes
final_df_T02 <- inner_join(all_df_selection_T02, selection_part_T02, by = "ID_T02")
#glimpse(final_df_T02)

#mit bisherigem dataframe zusammenführen
final_df_T02 <- inner_join(final_df_T01, final_df_T02, by = "ID_Fahrzeug")
glimpse(final_df_T02)
#write.csv(final_df_T02, "final_df_T02.csv", row.names = TRUE)
```





